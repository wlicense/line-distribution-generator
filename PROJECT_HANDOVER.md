# AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¼•ãç¶™ãŽæ›¸

## ðŸ“‹ ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå
**AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒª - 3å±¤ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³ãƒ¢ãƒ‡ãƒ« + ãƒªã‚»ãƒ©ãƒ¼æ©Ÿèƒ½**

### ç›®çš„
- 500/1000/2000å€‹ã®AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’3ã¤ã®ãƒ—ãƒ©ãƒ³ã§æä¾›
- ç„¡æ–™ã‚µãƒ­ãƒ³ç”Ÿã‹ã‚‰ã‚µãƒ–ã‚¹ã‚¯è»¢æ›ã‚’æœ€å¤§åŒ–
- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå…±æœ‰ã«ã‚ˆã‚‹ãƒã‚¤ãƒ©ãƒ«æ‹¡æ•£
- é«˜åˆ©ç›ŠçŽ‡ï¼ˆ98%ä»¥ä¸Šï¼‰ã®SaaSãƒ“ã‚¸ãƒã‚¹

### ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
- âœ… ä¾¡æ ¼è¨­å®šãƒ¢ãƒ‡ãƒ«å®Œæˆï¼ˆå¿ƒç†å­¦åˆ†æžæ¸ˆã¿ï¼‰
- âœ… ãƒªã‚»ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒ«è¨­è¨ˆå®Œæˆ
- âœ… ãƒ¦ãƒ¼ã‚¶ãƒ¼å‹•ç·šè¨­è¨ˆå®Œæˆ
- â³ å®Ÿè£…å¾…ã¡ï¼ˆã“ã‚Œã‹ã‚‰é–‹å§‹ï¼‰

---

## ðŸŽ¯ ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«

### 3ã¤ã®ãƒ—ãƒ©ãƒ³

| ãƒ—ãƒ©ãƒ³ | æœˆé¡ | å›žæ•° | ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå…±æœ‰ | ä¸»ãªæ©Ÿèƒ½ |
|--------|------|------|--------------|----------|
| **ç„¡æ–™ã‚µãƒ­ãƒ³ç”Ÿ** | ç„¡æ–™ | æœˆ10å›ž | âœ… OK | ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆåˆ©ç”¨ã®ã¿ |
| **ã‚µãƒ–ã‚¹ã‚¯ç”Ÿ** | 9,800å†† | æœˆ200å›ž | âœ… OK | ã‚°ãƒ«ã‚³ãƒ³å‚åŠ  + ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ |
| **æœ¬ã‚³ãƒ¼ã‚¹ç”Ÿ** | 19,800å†† | æœˆ1,000å›ž | âœ… OK | æœ¬ã‚³ãƒ¼ã‚¹å…¨ç‰¹å…¸ + ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ |

### é‡è¦ãªç‰¹å¾´
1. **å…¨ãƒ—ãƒ©ãƒ³ã§ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå…±æœ‰OK** â†’ ãƒªã‚»ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒ«
2. **è¿½åŠ ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆè²©å£²ãªã—** â†’ ã‚·ãƒ³ãƒ—ãƒ«ãªæ–™é‡‘ä½“ç³»
3. **é›»è©±ç•ªå·ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼** â†’ SMSé€šçŸ¥é€£æº
4. **å¸å£²ä¾¡æ ¼ãƒ¢ãƒ‡ãƒ«** â†’ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè‡ªç”±ã«ä¾¡æ ¼è¨­å®šå¯èƒ½

---

## ðŸ’° åŽç›Šãƒ¢ãƒ‡ãƒ«

### åŽŸä¾¡æ§‹é€ 
- APIå˜ä¾¡: 0.38å††/å›žï¼ˆGPT-3.5 Turboï¼‰
- ã‚¤ãƒ³ãƒ•ãƒ©: 6,000å††/500äºº or 45å††/äºº

### ç²—åˆ©çŽ‡
- ç„¡æ–™: ã‚³ã‚¹ãƒˆ7,900å††/500äººï¼ˆäºˆç®—å†…ï¼‰
- ã‚µãƒ–ã‚¹ã‚¯: ç²—åˆ©çŽ‡98.8%ï¼ˆåŽŸä¾¡121å††/æœˆï¼‰
- æœ¬ã‚³ãƒ¼ã‚¹: ç²—åˆ©çŽ‡97.9%ï¼ˆåŽŸä¾¡425å††/æœˆï¼‰

### ãƒªã‚»ãƒ©ãƒ¼åŽç›Šä¾‹
- å€‹äººã‚³ãƒ¼ãƒ: 10åã«15,000å††ã§è²©å£² â†’ æœˆ52,000å††åˆ©ç›Š
- ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚µãƒ­ãƒ³: 50åã«ä»˜åŠ ä¾¡å€¤æä¾› â†’ ä¼šå“¡æº€è¶³åº¦UP
- å®¶æ—ã‚·ã‚§ã‚¢: 4äººã§å‰²ã‚Šå‹˜ â†’ 1äºº2,450å††/æœˆ

---

## ðŸ” èªè¨¼ãƒ»æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ 

### èªè¨¼æ–¹å¼
- **ãƒ­ã‚°ã‚¤ãƒ³ID**: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
- **ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰**: é›»è©±ç•ªå·ï¼ˆãƒã‚¤ãƒ•ãƒ³ãªã—ã€ä¾‹: 09012345678ï¼‰
- **SMSèªè¨¼**: TwilioçµŒç”±ã§ç¢ºèªã‚³ãƒ¼ãƒ‰é€ä¿¡

### æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ï¼ˆUnivaPayï¼‰
- **æ±ºæ¸ˆãƒªãƒ³ã‚¯**: https://univa.cc/i3anjt
- **é‡‘é¡**: 9,800å††ï¼ˆå›ºå®šï¼‰
- **ç”¨é€”**: ã‚µãƒ–ã‚¹ã‚¯ç”Ÿãƒ—ãƒ©ãƒ³ç”³ã—è¾¼ã¿
- **é‡è¦**: ã“ã®ãƒªãƒ³ã‚¯1å€‹ã®ã¿ã€1å€‹ãšã¤ç”³ã—è¾¼ã¿ã•ã›ã‚‹
- **æœ¬ã‚³ãƒ¼ã‚¹ç”Ÿ**: åˆ¥é€”19,800å††ã®æ±ºæ¸ˆãƒªãƒ³ã‚¯ãŒå¿…è¦ï¼ˆæœªä½œæˆï¼‰

### Twilio SMSè¨­å®š
```
ç”¨é€”:
1. æ–°è¦ç™»éŒ²å®Œäº†é€šçŸ¥ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±é€ä¿¡ï¼‰
2. ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ é€šçŸ¥
3. æ±ºæ¸ˆå®Œäº†é€šçŸ¥
4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªãƒžã‚¤ãƒ³ãƒ€ãƒ¼

SMSé€ä¿¡å…ˆ: ç™»éŒ²ã—ãŸé›»è©±ç•ªå·
å½¢å¼: æ—¥æœ¬ã®æºå¸¯ç•ªå·ï¼ˆ090/080/070ã‹ã‚‰å§‹ã¾ã‚‹11æ¡ï¼‰
```

---

## ðŸ“‚ ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆ

### æ—¢å­˜ã‚·ã‚¹ãƒ†ãƒ ï¼ˆç¾åœ¨ç¨¼åƒä¸­ï¼‰

#### 500ç‰ˆï¼ˆç„¡æ–™ã‚µãƒ­ãƒ³ç”Ÿç”¨ï¼‰
- **ãƒ‘ã‚¹**: `/Users/hajime/Desktop/n8n/chat_system/`
- **ãƒãƒ¼ãƒˆ**: 5004
- **ãƒ‡ãƒ¼ã‚¿**: SQLite (`chat_system.db`)
- **HTML**: `templates/dashboard.html`
- **ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ**: HTMLã«ç›´æŽ¥åŸ‹ã‚è¾¼ã¿

#### 1000ç‰ˆï¼ˆã‚µãƒ–ã‚¹ã‚¯ç”Ÿç”¨ï¼‰
- **ãƒ‘ã‚¹**: `/Users/hajime/Desktop/n8n/chat_system_1000/`
- **ãƒãƒ¼ãƒˆ**: 5005
- **ãƒ‡ãƒ¼ã‚¿**: JSON (`prompts_1000_data.json`)
- **HTML**: `templates/dashboard.html`

#### 2000ç‰ˆï¼ˆæœ¬ã‚³ãƒ¼ã‚¹ç”Ÿç”¨ï¼‰
- **ãƒ‘ã‚¹**: `/Users/hajime/Desktop/n8n/chat_system_2000/`
- **ãƒãƒ¼ãƒˆ**: 5006
- **ãƒ‡ãƒ¼ã‚¿**: JSON (`prompts_2000_data.json`)
- **HTML**: `templates/dashboard.html`

### åˆ†æžãƒ»è¨­è¨ˆãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆï¼ˆä½œæˆæ¸ˆã¿ï¼‰

```
/Users/hajime/Desktop/
â”œâ”€â”€ reseller_model_analysis.py          # ãƒªã‚»ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒ«åˆ†æž
â”œâ”€â”€ user_flow_design.md                 # ãƒ¦ãƒ¼ã‚¶ãƒ¼å‹•ç·šè¨­è¨ˆï¼ˆâ˜…é‡è¦ï¼‰
â”œâ”€â”€ final_pricing_model.md              # æœ€çµ‚ä¾¡æ ¼è¨­å®š
â”œâ”€â”€ subscription_tier_analysis.py       # ã‚µãƒ–ã‚¹ã‚¯å±¤åˆ†æžï¼ˆ200å›žæŽ¨å¥¨ï¼‰
â”œâ”€â”€ freemium_psychology_analysis.py     # å¿ƒç†å­¦åˆ†æžï¼ˆ10å›žæŽ¨å¥¨ï¼‰
â”œâ”€â”€ credit_pricing_90percent_profit.py  # ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆä¾¡æ ¼è¨­å®š
â”œâ”€â”€ free_tier_500_users_analysis.py     # ç„¡æ–™å±¤500äººåˆ†æž
â”œâ”€â”€ revised_pricing_model.py            # æ”¹è¨‚ä¾¡æ ¼ãƒ¢ãƒ‡ãƒ«
â”œâ”€â”€ business_model_proposal.md          # ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«ææ¡ˆ
â””â”€â”€ PROJECT_HANDOVER.md                 # ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«
```

---

## ðŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

### users ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ä½œæˆãŒå¿…è¦ï¼‰

```sql
CREATE TABLE users (
    id INTEGER PRIMARY KEY AUTOINCREMENT,

    -- èªè¨¼æƒ…å ±
    email TEXT UNIQUE NOT NULL,              -- ãƒ­ã‚°ã‚¤ãƒ³ID
    phone TEXT NOT NULL,                     -- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼ˆé›»è©±ç•ªå·ï¼‰
    name TEXT NOT NULL,                      -- æ°å

    -- ãƒ—ãƒ©ãƒ³æƒ…å ±
    plan TEXT DEFAULT 'free',                -- 'free', 'sub', 'premium'
    monthly_limit INTEGER DEFAULT 10,        -- æœˆé–“åˆ©ç”¨ä¸Šé™
    monthly_usage INTEGER DEFAULT 0,         -- ä»Šæœˆã®ä½¿ç”¨å›žæ•°
    usage_reset_date DATE,                   -- ä½¿ç”¨å›žæ•°ãƒªã‚»ãƒƒãƒˆæ—¥

    -- ã‚¢ã‚«ã‚¦ãƒ³ãƒˆæ§‹é€ 
    master_account_id INTEGER,               -- ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®å ´åˆã€ãƒžã‚¹ã‚¿ãƒ¼ID
    is_master BOOLEAN DEFAULT 1,             -- ãƒžã‚¹ã‚¿ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹

    -- åŒæ„ãƒ»è¦ç´„
    terms_agreed BOOLEAN DEFAULT 0,          -- åˆ©ç”¨è¦ç´„åŒæ„
    sms_agreed BOOLEAN DEFAULT 0,            -- SMSé€ä¿¡åŒæ„
    terms_agreed_at DATETIME,                -- åŒæ„æ—¥æ™‚

    -- æ±ºæ¸ˆæƒ…å ±
    univapay_customer_id TEXT,               -- UnivaPayé¡§å®¢ID
    univapay_charge_id TEXT,                 -- æœ€æ–°æ±ºæ¸ˆID
    next_billing_date DATE,                  -- æ¬¡å›žæ±ºæ¸ˆæ—¥
    subscription_status TEXT DEFAULT 'none', -- 'none', 'active', 'cancelled'

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    last_login DATETIME,

    FOREIGN KEY (master_account_id) REFERENCES users(id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_email ON users(email);
CREATE INDEX idx_phone ON users(phone);
CREATE INDEX idx_master_account ON users(master_account_id);
CREATE INDEX idx_plan ON users(plan);
```

### sub_accounts ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ä½œæˆãŒå¿…è¦ï¼‰

```sql
CREATE TABLE sub_accounts (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    master_id INTEGER NOT NULL,              -- ãƒžã‚¹ã‚¿ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID
    sub_id INTEGER NOT NULL,                 -- ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆID
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    created_by INTEGER,                      -- ä½œæˆè€…ï¼ˆãƒžã‚¹ã‚¿ãƒ¼IDï¼‰
    status TEXT DEFAULT 'active',            -- 'active', 'suspended', 'deleted'

    FOREIGN KEY (master_id) REFERENCES users(id),
    FOREIGN KEY (sub_id) REFERENCES users(id),
    FOREIGN KEY (created_by) REFERENCES users(id),

    UNIQUE(master_id, sub_id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_master ON sub_accounts(master_id);
CREATE INDEX idx_sub ON sub_accounts(sub_id);
```

### payments ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ–°è¦ä½œæˆãŒå¿…è¦ï¼‰

```sql
CREATE TABLE payments (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,

    -- æ±ºæ¸ˆæƒ…å ±
    plan TEXT NOT NULL,                      -- 'sub', 'premium'
    amount INTEGER NOT NULL,                 -- 9800 or 19800
    currency TEXT DEFAULT 'JPY',

    -- UnivaPayé€£æº
    univapay_charge_id TEXT UNIQUE,
    univapay_customer_id TEXT,

    -- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹
    status TEXT DEFAULT 'pending',           -- 'pending', 'completed', 'failed', 'refunded'
    payment_method TEXT,                     -- 'credit_card', etc.

    -- ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿
    metadata TEXT,                           -- JSONå½¢å¼ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿

    -- ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    completed_at DATETIME,

    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_payments ON payments(user_id);
CREATE INDEX idx_univapay_charge ON payments(univapay_charge_id);
CREATE INDEX idx_payment_status ON payments(status);
```

### usage_logs ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆæ—¢å­˜æ‹¡å¼µãŒå¿…è¦ï¼‰

```sql
-- æ—¢å­˜ã®chat_logsãƒ†ãƒ¼ãƒ–ãƒ«ã‚’æ‹¡å¼µã™ã‚‹ã‹ã€æ–°è¦ä½œæˆ
CREATE TABLE usage_logs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    user_id INTEGER NOT NULL,
    prompt_number INTEGER NOT NULL,          -- ä½¿ç”¨ã—ãŸãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç•ªå·
    prompt_title TEXT,
    api_cost REAL DEFAULT 0.38,              -- APIåŽŸä¾¡
    used_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id)
);

-- ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_user_usage ON usage_logs(user_id);
CREATE INDEX idx_usage_date ON usage_logs(used_at);
```

---

## ðŸ”Œ APIé€£æº

### 1. UnivaPayæ±ºæ¸ˆ

#### åŸºæœ¬æƒ…å ±
```
æ±ºæ¸ˆãƒªãƒ³ã‚¯: https://univa.cc/i3anjt
é‡‘é¡: 9,800å††ï¼ˆå›ºå®šï¼‰
ç”¨é€”: ã‚µãƒ–ã‚¹ã‚¯ç”Ÿãƒ—ãƒ©ãƒ³ç”³ã—è¾¼ã¿

âš ï¸ é‡è¦åˆ¶ç´„:
- ã“ã®ãƒªãƒ³ã‚¯1å€‹ã®ã¿ä½¿ç”¨å¯èƒ½
- 1å€‹ãšã¤ç”³ã—è¾¼ã¿ã•ã›ã‚‹ï¼ˆåŒæ™‚ã«è¤‡æ•°ç”³ã—è¾¼ã¿ä¸å¯ï¼‰
- æœ¬ã‚³ãƒ¼ã‚¹ç”Ÿï¼ˆ19,800å††ï¼‰ã¯åˆ¥é€”ãƒªãƒ³ã‚¯ãŒå¿…è¦
```

#### å®Ÿè£…æ–¹é‡
```python
# config.py
UNIVAPAY_PAYMENT_LINK = "https://univa.cc/i3anjt"
SUBSCRIPTION_PRICE = 9800  # å††

# ç”³ã—è¾¼ã¿ãƒ•ãƒ­ãƒ¼
# 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã‚µãƒ–ã‚¹ã‚¯ç”Ÿã«ç”³ã—è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯
# 2. ç¢ºèªç”»é¢è¡¨ç¤ºï¼ˆé‡‘é¡: 9,800å††ï¼‰
# 3. UnivaPayæ±ºæ¸ˆãƒªãƒ³ã‚¯ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
# 4. æ±ºæ¸ˆå®Œäº†å¾Œã€Webhookã§é€šçŸ¥å—ä¿¡
# 5. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ï¼ˆplan='sub', monthly_limit=200ï¼‰
# 6. SMSé€ä¿¡ï¼ˆæ±ºæ¸ˆå®Œäº†é€šçŸ¥ï¼‰
```

#### Webhookå‡¦ç†ï¼ˆé‡è¦ï¼‰
```python
@app.route('/webhook/univapay', methods=['POST'])
def univapay_webhook():
    """
    UnivaPayæ±ºæ¸ˆå®Œäº†æ™‚ã®Webhook

    æƒ³å®šãƒšã‚¤ãƒ­ãƒ¼ãƒ‰:
    {
        "event": "charge.finished",
        "data": {
            "id": "charge_xxx",
            "amount": 9800,
            "currency": "JPY",
            "status": "successful",
            "metadata": {
                "user_id": "12345",
                "plan": "sub"
            }
        }
    }
    """
    payload = request.json

    # 1. ç½²åæ¤œè¨¼ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼‰
    # 2. user_idå–å¾—
    # 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
    # 4. SMSé€ä¿¡
    # 5. 200 OKè¿”å´

    return jsonify({"status": "ok"}), 200
```

### 2. Twilio SMS

#### åŸºæœ¬æƒ…å ±
```
ç”¨é€”: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®é€šçŸ¥ãƒ»èªè¨¼
é€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°:
  1. æ–°è¦ç™»éŒ²å®Œäº†æ™‚
  2. ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ æ™‚
  3. æ±ºæ¸ˆå®Œäº†æ™‚
  4. ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªãƒžã‚¤ãƒ³ãƒ€ãƒ¼

å¿…è¦ãªç’°å¢ƒå¤‰æ•°:
  TWILIO_ACCOUNT_SID=ACxxxxxxxxxx
  TWILIO_AUTH_TOKEN=your_auth_token
  TWILIO_PHONE_NUMBER=+815012345678
```

#### å®Ÿè£…ä¾‹
```python
from twilio.rest import Client

def send_sms(to_phone, message):
    """
    SMSé€ä¿¡

    Args:
        to_phone: é€ä¿¡å…ˆé›»è©±ç•ªå·ï¼ˆä¾‹: 09012345678ï¼‰
        message: é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

    Returns:
        message.sid: Twilio ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ID
    """
    # é›»è©±ç•ªå·ã‚’å›½éš›å½¢å¼ã«å¤‰æ›
    if to_phone.startswith('0'):
        to_phone = '+81' + to_phone[1:]

    client = Client(TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN)

    message = client.messages.create(
        body=message,
        from_=TWILIO_PHONE_NUMBER,
        to=to_phone
    )

    return message.sid

# ä½¿ç”¨ä¾‹: æ–°è¦ç™»éŒ²æ™‚
def send_registration_sms(user):
    message = f"""AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¸ã‚ˆã†ã“ãï¼

ã€ãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ã€‘
ID: {user.email}
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: {user.phone}

ã€é‡è¦ãªãƒªãƒ³ã‚¯ã€‘
åˆ©ç”¨è¦ç´„: https://example.com/terms
ãƒ­ã‚°ã‚¤ãƒ³: https://example.com/login

ã”ç™»éŒ²ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚"""

    send_sms(user.phone, message)
```

---

## ðŸŽ¨ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‹•ç·šï¼ˆè©³ç´°ã¯ user_flow_design.md å‚ç…§ï¼‰

### 1. æ–°è¦ç™»éŒ²ãƒ•ãƒ­ãƒ¼

```
ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸
   â†“
ã€Œæ–°è¦ç™»éŒ²ã€ãƒœã‚¿ãƒ³
   â†“
ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
   - é›»è©±ç•ªå·
   - æ°å
   â˜‘ åˆ©ç”¨è¦ç´„ã«åŒæ„ã™ã‚‹
   â˜‘ SMSé€ä¿¡ã«åŒæ„ã™ã‚‹
   â†“
SMSé€ä¿¡ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±ï¼‰
   â†“
ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
```

### 2. ãƒ­ã‚°ã‚¤ãƒ³ãƒ•ãƒ­ãƒ¼

```
ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
   â†“
ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹: user@example.com
ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: 09012345678ï¼ˆé›»è©±ç•ªå·ï¼‰
   â†“
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
```

### 3. ã‚µãƒ–ã‚¹ã‚¯ç”³ã—è¾¼ã¿ãƒ•ãƒ­ãƒ¼

```
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
   â†“
ã€Œã‚µãƒ–ã‚¹ã‚¯ç”Ÿã«ç”³ã—è¾¼ã‚€ã€ãƒœã‚¿ãƒ³
   â†“
ç¢ºèªç”»é¢:
  - ãƒ—ãƒ©ãƒ³: ã‚µãƒ–ã‚¹ã‚¯ç”Ÿ
  - æœˆé¡: 9,800å††
  - å›žæ•°: æœˆ200å›ž
  - ã‚°ãƒ«ã‚³ãƒ³å‚åŠ æ¨©
  â˜‘ åˆ©ç”¨è¦ç´„ã«åŒæ„ã™ã‚‹
   â†“
UnivaPayæ±ºæ¸ˆãƒªãƒ³ã‚¯ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
https://univa.cc/i3anjt
   â†“
ã‚«ãƒ¼ãƒ‰æƒ…å ±å…¥åŠ›ãƒ»æ±ºæ¸ˆ
   â†“
Webhookå—ä¿¡ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ï¼‰
   â†“
ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°:
  - plan = 'sub'
  - monthly_limit = 200
  - next_billing_date = now + 1 month
   â†“
SMSé€ä¿¡ï¼ˆæ±ºæ¸ˆå®Œäº†é€šçŸ¥ï¼‰
   â†“
æ±ºæ¸ˆå®Œäº†ãƒšãƒ¼ã‚¸
   â†“
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
```

### 4. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå…±æœ‰ãƒ•ãƒ­ãƒ¼

```
ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒžã‚¹ã‚¿ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆï¼‰
   â†“
ã€Œã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ã€ã‚¿ãƒ–
   â†“
ã€Œæ–°è¦ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ ã€
   - ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
   - é›»è©±ç•ªå·
   - æ°å
   â†“
ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆ
   â†“
SMSé€ä¿¡ï¼ˆã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ï¼‰:
  ã€Œ{ãƒžã‚¹ã‚¿ãƒ¼æ°å}ã•ã‚“ã‹ã‚‰ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãŒå…±æœ‰ã•ã‚Œã¾ã—ãŸã€
   â†“
ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã§ãƒ­ã‚°ã‚¤ãƒ³å¯èƒ½
```

---

## ðŸ› ï¸ æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰
- **è¨€èªž**: Python 3.x
- **ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯**: Flask
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: SQLite3
- **èªè¨¼**: Flask-Loginï¼ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ï¼‰
- **APIé€£æº**: requests, twilio

### ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰
- **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ**: Jinja2
- **CSS**: ã‚«ã‚¹ã‚¿ãƒ CSSï¼ˆæ—¢å­˜ï¼‰
- **JavaScript**: ãƒãƒ‹ãƒ©JS

### å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
- **UnivaPay**: æ±ºæ¸ˆå‡¦ç†
- **Twilio**: SMSé€ä¿¡
- **OpenAI**: GPT-3.5 Turbo API

### ç’°å¢ƒå¤‰æ•°ï¼ˆ.env ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
```bash
# OpenAI
OPENAI_API_KEY=sk-xxxxx

# Twilio
TWILIO_ACCOUNT_SID=ACxxxxx
TWILIO_AUTH_TOKEN=xxxxx
TWILIO_PHONE_NUMBER=+815012345678

# UnivaPay
UNIVAPAY_PAYMENT_LINK=https://univa.cc/i3anjt
UNIVAPAY_WEBHOOK_SECRET=xxxxx

# App
FLASK_SECRET_KEY=your-secret-key
DATABASE_PATH=/Users/hajime/Desktop/n8n/chat_system/chat_system.db
```

---

## ðŸ“ å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

### ãƒ•ã‚§ãƒ¼ã‚º1: èªè¨¼ã‚·ã‚¹ãƒ†ãƒ ï¼ˆå„ªå…ˆåº¦: æœ€é«˜ï¼‰

#### ã‚¿ã‚¹ã‚¯
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆusersãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆï¼‰
- [ ] æ–°è¦ç™»éŒ²ç”»é¢ï¼ˆregister.htmlï¼‰
- [ ] ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ï¼ˆlogin.htmlï¼‰
- [ ] é›»è©±ç•ªå·ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰èªè¨¼å®Ÿè£…
- [ ] Twilio SMSé€£æº
- [ ] åˆ©ç”¨è¦ç´„ãƒšãƒ¼ã‚¸ä½œæˆ
- [ ] åŒæ„ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹å®Ÿè£…

#### æœŸå¾…ã•ã‚Œã‚‹æˆæžœç‰©
```
/Users/hajime/Desktop/n8n/chat_system/
â”œâ”€â”€ app.pyï¼ˆæ‹¡å¼µï¼‰
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ register.htmlï¼ˆæ–°è¦ï¼‰
â”‚   â”œâ”€â”€ login.htmlï¼ˆæ–°è¦ï¼‰
â”‚   â””â”€â”€ terms.htmlï¼ˆæ–°è¦ï¼‰
â”œâ”€â”€ static/
â”‚   â””â”€â”€ css/auth.cssï¼ˆæ–°è¦ï¼‰
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 001_create_users_table.sqlï¼ˆæ–°è¦ï¼‰
â””â”€â”€ utils/
    â””â”€â”€ sms.pyï¼ˆæ–°è¦ï¼‰
```

### ãƒ•ã‚§ãƒ¼ã‚º2: UnivaPayæ±ºæ¸ˆé€£æºï¼ˆå„ªå…ˆåº¦: é«˜ï¼‰

#### ã‚¿ã‚¹ã‚¯
- [ ] ãƒ—ãƒ©ãƒ³é¸æŠžç”»é¢ï¼ˆplans.htmlï¼‰
- [ ] ã‚µãƒ–ã‚¹ã‚¯ç”³ã—è¾¼ã¿ç¢ºèªç”»é¢
- [ ] UnivaPayæ±ºæ¸ˆãƒªãƒ³ã‚¯ã¸ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè£…
- [ ] Webhookã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆä½œæˆ
- [ ] æ±ºæ¸ˆå®Œäº†å‡¦ç†å®Ÿè£…
- [ ] æ±ºæ¸ˆå®Œäº†SMSé€ä¿¡
- [ ] paymentsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ»è¨˜éŒ²

#### æœŸå¾…ã•ã‚Œã‚‹æˆæžœç‰©
```
/Users/hajime/Desktop/n8n/chat_system/
â”œâ”€â”€ app.pyï¼ˆæ‹¡å¼µï¼‰
â”œâ”€â”€ templates/
â”‚   â”œâ”€â”€ plans.htmlï¼ˆæ–°è¦ï¼‰
â”‚   â”œâ”€â”€ subscribe_confirm.htmlï¼ˆæ–°è¦ï¼‰
â”‚   â””â”€â”€ payment_success.htmlï¼ˆæ–°è¦ï¼‰
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 002_create_payments_table.sqlï¼ˆæ–°è¦ï¼‰
â””â”€â”€ utils/
    â””â”€â”€ univapay.pyï¼ˆæ–°è¦ï¼‰
```

### ãƒ•ã‚§ãƒ¼ã‚º3: ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå…±æœ‰æ©Ÿèƒ½ï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

#### ã‚¿ã‚¹ã‚¯
- [ ] ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç®¡ç†ç”»é¢ï¼ˆaccount_management.htmlï¼‰
- [ ] ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ æ©Ÿèƒ½
- [ ] ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ—ãƒ¼ãƒ«ç®¡ç†
- [ ] sub_accountsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¸ã®SMSé€šçŸ¥
- [ ] ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå‰Šé™¤æ©Ÿèƒ½

#### æœŸå¾…ã•ã‚Œã‚‹æˆæžœç‰©
```
/Users/hajime/Desktop/n8n/chat_system/
â”œâ”€â”€ app.pyï¼ˆæ‹¡å¼µï¼‰
â”œâ”€â”€ templates/
â”‚   â””â”€â”€ account_management.htmlï¼ˆæ–°è¦ï¼‰
â”œâ”€â”€ migrations/
â”‚   â””â”€â”€ 003_create_sub_accounts_table.sqlï¼ˆæ–°è¦ï¼‰
â””â”€â”€ utils/
    â””â”€â”€ account_sharing.pyï¼ˆæ–°è¦ï¼‰
```

### ãƒ•ã‚§ãƒ¼ã‚º4: ä½¿ç”¨å›žæ•°ç®¡ç†ãƒ»ãƒªã‚»ãƒƒãƒˆï¼ˆå„ªå…ˆåº¦: ä¸­ï¼‰

#### ã‚¿ã‚¹ã‚¯
- [ ] æœˆæ¬¡ä½¿ç”¨å›žæ•°ãƒªã‚»ãƒƒãƒˆï¼ˆCron/ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ©ãƒ¼ï¼‰
- [ ] ä½¿ç”¨å›žæ•°ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
- [ ] ä½¿ç”¨ä¸Šé™åˆ°é”æ™‚ã®é€šçŸ¥
- [ ] usage_logsãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ
- [ ] ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã«ä½¿ç”¨çŠ¶æ³è¡¨ç¤º

#### æœŸå¾…ã•ã‚Œã‚‹æˆæžœç‰©
```
/Users/hajime/Desktop/n8n/chat_system/
â”œâ”€â”€ cron/
â”‚   â””â”€â”€ reset_monthly_usage.pyï¼ˆæ–°è¦ï¼‰
â”œâ”€â”€ utils/
â”‚   â””â”€â”€ usage_manager.pyï¼ˆæ–°è¦ï¼‰
â””â”€â”€ templates/
    â””â”€â”€ dashboard.htmlï¼ˆæ‹¡å¼µï¼‰
```

---

## ðŸš¨ é‡è¦ãªåˆ¶ç´„ãƒ»æ³¨æ„äº‹é …

### 1. UnivaPayæ±ºæ¸ˆãƒªãƒ³ã‚¯
```
âš ï¸ è¶…é‡è¦:
- æ±ºæ¸ˆãƒªãƒ³ã‚¯: https://univa.cc/i3anjt
- é‡‘é¡: 9,800å††ï¼ˆå›ºå®šï¼‰
- ã“ã®ãƒªãƒ³ã‚¯1å€‹ã—ã‹ãªã„
- 1å€‹ãšã¤ç”³ã—è¾¼ã¿ã•ã›ã‚‹ï¼ˆåŒæ™‚ç”³ã—è¾¼ã¿ä¸å¯ï¼‰
- ã‚µãƒ–ã‚¹ã‚¯ç”Ÿãƒ—ãƒ©ãƒ³ã®ã¿å¯¾å¿œ
- æœ¬ã‚³ãƒ¼ã‚¹ç”Ÿï¼ˆ19,800å††ï¼‰ã¯åˆ¥é€”ãƒªãƒ³ã‚¯ãŒå¿…è¦ï¼ˆæœªä½œæˆï¼‰

å®Ÿè£…ä¸Šã®å¯¾å¿œ:
- ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œç”³ã—è¾¼ã‚€ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯
- ç¢ºèªç”»é¢ã§ã€Œé‡‘é¡: 9,800å††ã€ã‚’æ˜Žç¤º
- UnivaPayæ±ºæ¸ˆãƒªãƒ³ã‚¯ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
- Webhookã§æ±ºæ¸ˆå®Œäº†ã‚’æ¤œçŸ¥
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°ï¼ˆplan='sub', monthly_limit=200ï¼‰
```

### 2. é›»è©±ç•ªå·ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
```
âš ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®:
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¯é›»è©±ç•ªå·ï¼ˆãƒã‚¤ãƒ•ãƒ³ãªã—ï¼‰
- ä¾‹: 09012345678
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ã¯ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦ä¿å­˜
- SMSé€ä¿¡æ™‚ã¯å¹³æ–‡ã§é€ä¿¡ï¼ˆãƒ­ã‚°ã‚¤ãƒ³æƒ…å ±é€šçŸ¥ã®ãŸã‚ï¼‰

å®Ÿè£…:
from werkzeug.security import generate_password_hash, check_password_hash

# ç™»éŒ²æ™‚
hashed_phone = generate_password_hash(phone)

# ãƒ­ã‚°ã‚¤ãƒ³æ™‚
if check_password_hash(user.phone, entered_phone):
    # ãƒ­ã‚°ã‚¤ãƒ³æˆåŠŸ
```

### 3. ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå…±æœ‰åˆ¶é™
```
âš ï¸ ãƒªã‚¹ã‚¯ç®¡ç†:
- 1ãƒžã‚¹ã‚¿ãƒ¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚ãŸã‚Šã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸Šé™: 50å
- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ—ãƒ¼ãƒ«ã¯å…±æœ‰ï¼ˆå…¨ã‚µãƒ–ãŒæ¶ˆè²»ï¼‰
- ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã¯ã‚°ãƒ«ã‚³ãƒ³å‚åŠ ä¸å¯ï¼ˆãƒžã‚¹ã‚¿ãƒ¼ã®ã¿ï¼‰

å®Ÿè£…:
# ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ æ™‚
if count_sub_accounts(master_id) >= 50:
    return error("ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä¸Šé™ï¼ˆ50åï¼‰ã«é”ã—ã¦ã„ã¾ã™")
```

### 4. SMSé€ä¿¡ã‚³ã‚¹ãƒˆ
```
âš ï¸ ã‚³ã‚¹ãƒˆç®¡ç†:
- Twilio: ç´„10å††/é€š
- é€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’æœ€å°é™ã«
- å¿…é ˆ: æ–°è¦ç™»éŒ²ã€æ±ºæ¸ˆå®Œäº†ã€ã‚µãƒ–ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¿½åŠ 
- ä»»æ„: ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãƒªãƒžã‚¤ãƒ³ãƒ€ãƒ¼

å®Ÿè£…:
# SMSé€ä¿¡ãƒ­ã‚°ã‚’è¨˜éŒ²
CREATE TABLE sms_logs (
    id INTEGER PRIMARY KEY,
    user_id INTEGER,
    phone TEXT,
    message TEXT,
    sent_at DATETIME,
    twilio_sid TEXT,
    status TEXT
);
```

---

## ðŸ” æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ç†è§£

### ç¾åœ¨ã® app.py æ§‹é€ ï¼ˆ500ç‰ˆï¼‰

```python
# /Users/hajime/Desktop/n8n/chat_system/app.py

from flask import Flask, render_template, request, session, redirect, url_for
import sqlite3
import openai

app = Flask(__name__)

# ä¸»è¦ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
@app.route('/')
def index():
    # ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
    # ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰è¡¨ç¤º

@app.route('/chat', methods=['POST'])
def chat():
    # ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆä½¿ç”¨
    # OpenAI APIå‘¼ã³å‡ºã—
    # ä½¿ç”¨å›žæ•°ã‚«ã‚¦ãƒ³ãƒˆ
    # chat_logsã«è¨˜éŒ²

@app.route('/login', methods=['GET', 'POST'])
def login():
    # ç¾åœ¨ã¯ãƒ¡ã‚¢ãƒ‰ï¼‹ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
    # â†’é›»è©±ç•ªå·ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã«å¤‰æ›´å¿…è¦

# ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
def get_db():
    conn = sqlite3.connect('chat_system.db')
    return conn

# æ—¢å­˜ãƒ†ãƒ¼ãƒ–ãƒ«
# - users
# - chat_logs
# - usage_limits
# - advertisements
# - leak_attempts
# - payment_history
```

### å¿…è¦ãªå¤‰æ›´ç‚¹

1. **usersãƒ†ãƒ¼ãƒ–ãƒ«æ‹¡å¼µ**
```sql
-- æ—¢å­˜ã®usersãƒ†ãƒ¼ãƒ–ãƒ«ã«è¿½åŠ ã‚«ãƒ©ãƒ 
ALTER TABLE users ADD COLUMN phone TEXT;
ALTER TABLE users ADD COLUMN plan TEXT DEFAULT 'free';
ALTER TABLE users ADD COLUMN monthly_limit INTEGER DEFAULT 10;
ALTER TABLE users ADD COLUMN monthly_usage INTEGER DEFAULT 0;
ALTER TABLE users ADD COLUMN master_account_id INTEGER;
ALTER TABLE users ADD COLUMN is_master BOOLEAN DEFAULT 1;
-- ãªã©
```

2. **èªè¨¼ãƒ­ã‚¸ãƒƒã‚¯å¤‰æ›´**
```python
# æ—§: ãƒ¡ã‚¢ãƒ‰ + ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰
# æ–°: ãƒ¡ã‚¢ãƒ‰ + é›»è©±ç•ªå·

@app.route('/login', methods=['POST'])
def login():
    email = request.form['email']
    phone = request.form['phone']  # é›»è©±ç•ªå·ã‚’ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨ã—ã¦ä½¿ç”¨

    user = get_user_by_email(email)
    if user and check_password_hash(user.phone, phone):
        session['user_id'] = user.id
        return redirect(url_for('dashboard'))
```

3. **ä½¿ç”¨å›žæ•°ãƒã‚§ãƒƒã‚¯**
```python
@app.route('/chat', methods=['POST'])
def chat():
    user = get_current_user()

    # ãƒ—ãƒ©ãƒ³ã«å¿œã˜ãŸä¸Šé™ãƒã‚§ãƒƒã‚¯
    if user.monthly_usage >= user.monthly_limit:
        return jsonify({
            "error": "ä»Šæœˆã®åˆ©ç”¨ä¸Šé™ã«é”ã—ã¾ã—ãŸ",
            "message": "ãƒ—ãƒ©ãƒ³ã‚’ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„",
            "upgrade_link": "/plans"
        })

    # OpenAI APIå‘¼ã³å‡ºã—
    # ...

    # ä½¿ç”¨å›žæ•°ã‚«ã‚¦ãƒ³ãƒˆ
    user.monthly_usage += 1
    update_user_usage(user.id, user.monthly_usage)
```

---

## ðŸ“š å‚è€ƒãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

### ä½œæˆæ¸ˆã¿ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
1. **user_flow_design.md** - ãƒ¦ãƒ¼ã‚¶ãƒ¼å‹•ç·šè¨­è¨ˆï¼ˆâ˜…æœ€é‡è¦ï¼‰
2. **reseller_model_analysis.py** - ãƒªã‚»ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒ«åˆ†æž
3. **final_pricing_model.md** - æœ€çµ‚ä¾¡æ ¼è¨­å®š
4. **freemium_psychology_analysis.py** - ç„¡æ–™10å›žã®å¿ƒç†å­¦çš„æ ¹æ‹ 

### å¤–éƒ¨ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ
- UnivaPay API: ï¼ˆURLä¸æ˜Žã€è¦ç¢ºèªï¼‰
- Twilio SMS API: https://www.twilio.com/docs/sms
- OpenAI API: https://platform.openai.com/docs

---

## ðŸŽ¯ æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå®Ÿè£…é–‹å§‹æ™‚ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—1: ç’°å¢ƒæº–å‚™
```bash
cd /Users/hajime/Desktop/n8n/chat_system

# ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
cat > .env << EOF
OPENAI_API_KEY=sk-xxxxx
TWILIO_ACCOUNT_SID=ACxxxxx
TWILIO_AUTH_TOKEN=xxxxx
TWILIO_PHONE_NUMBER=+815012345678
UNIVAPAY_PAYMENT_LINK=https://univa.cc/i3anjt
FLASK_SECRET_KEY=your-secret-key
EOF

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
pip install twilio python-dotenv
```

### ã‚¹ãƒ†ãƒƒãƒ—2: ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
```bash
# ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
cp chat_system.db chat_system.db.backup

# ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
python migrations/001_create_users_table.py
```

### ã‚¹ãƒ†ãƒƒãƒ—3: èªè¨¼ã‚·ã‚¹ãƒ†ãƒ å®Ÿè£…
```bash
# æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
touch templates/register.html
touch templates/login.html
touch templates/terms.html
touch utils/sms.py

# app.py æ‹¡å¼µé–‹å§‹
```

### ã‚¹ãƒ†ãƒƒãƒ—4: ãƒ†ã‚¹ãƒˆ
```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•
python app.py

# ãƒ–ãƒ©ã‚¦ã‚¶ã§ç¢ºèª
http://localhost:5004/register
http://localhost:5004/login
```

---

## ðŸ†˜ ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

### ã‚ˆãã‚ã‚‹å•é¡Œ

#### 1. Twilio SMSé€ä¿¡ã‚¨ãƒ©ãƒ¼
```
ã‚¨ãƒ©ãƒ¼: Unable to create record
åŽŸå› : é›»è©±ç•ªå·å½¢å¼ãŒé–“é•ã£ã¦ã„ã‚‹

è§£æ±ºç­–:
- æ—¥æœ¬ã®æºå¸¯: +8190xxxxxxxx å½¢å¼
- ãƒã‚¤ãƒ•ãƒ³ãªã—
- å…ˆé ­ã®0ã‚’å‰Šé™¤ã—ã¦+81ã‚’ä»˜ã‘ã‚‹
```

#### 2. UnivaPay Webhookå—ä¿¡ã§ããªã„
```
ã‚¨ãƒ©ãƒ¼: Webhookå‘¼ã°ã‚Œãªã„
åŽŸå› : UnivaPayå´ã®è¨­å®šä¸è¶³

è§£æ±ºç­–:
- UnivaPayç®¡ç†ç”»é¢ã§Webhook URLç™»éŒ²
- https://your-domain.com/webhook/univapay
- ngrokãªã©ã§ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºæ™‚ã‚‚ãƒ†ã‚¹ãƒˆå¯èƒ½
```

#### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒ­ãƒƒã‚¯
```
ã‚¨ãƒ©ãƒ¼: database is locked
åŽŸå› : SQLiteåŒæ™‚æ›¸ãè¾¼ã¿åˆ¶é™

è§£æ±ºç­–:
- connection.commit()å¾Œã«å¿…ãšclose()
- ã¾ãŸã¯ PostgreSQL/MySQLã¸ç§»è¡Œæ¤œè¨Ž
```

---

## ðŸ“ž é€£çµ¡å…ˆãƒ»ãƒªã‚½ãƒ¼ã‚¹

### ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚ªãƒ¼ãƒŠãƒ¼
- åå‰: Hajime
- ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: `/Users/hajime/Desktop/`

### é‡è¦ãªãƒªãƒ³ã‚¯
- UnivaPayæ±ºæ¸ˆ: https://univa.cc/i3anjt
- ã‚·ã‚¹ãƒ†ãƒ 500ç‰ˆ: http://localhost:5004
- ã‚·ã‚¹ãƒ†ãƒ 1000ç‰ˆ: http://localhost:5005
- ã‚·ã‚¹ãƒ†ãƒ 2000ç‰ˆ: http://localhost:5006

### é–‹ç™ºç’°å¢ƒ
- OS: macOS (Darwin 24.3.0)
- Python: 3.x
- Git: åˆæœŸåŒ–æ¸ˆã¿ï¼ˆ/Users/hajime/Desktop/.gitï¼‰

---

## âœ… ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆï¼ˆå®Ÿè£…å‰ã®ç¢ºèªï¼‰

### ç’°å¢ƒç¢ºèª
- [ ] Python 3.x ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¸ˆã¿
- [ ] pip ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒžãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆ©ç”¨å¯èƒ½
- [ ] Twilio ã‚¢ã‚«ã‚¦ãƒ³ãƒˆä½œæˆæ¸ˆã¿
- [ ] Twilio é›»è©±ç•ªå·å–å¾—æ¸ˆã¿
- [ ] UnivaPay ã‚¢ã‚«ã‚¦ãƒ³ãƒˆç¢ºèª
- [ ] OpenAI API ã‚­ãƒ¼å–å¾—æ¸ˆã¿

### è¨­è¨ˆç¢ºèª
- [ ] user_flow_design.md èª­äº†
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆç†è§£
- [ ] UnivaPayæ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ç†è§£
- [ ] SMSé€ä¿¡ã‚¿ã‚¤ãƒŸãƒ³ã‚°ç†è§£
- [ ] ã‚¢ã‚«ã‚¦ãƒ³ãƒˆå…±æœ‰ãƒ­ã‚¸ãƒƒã‚¯ç†è§£

### å®Ÿè£…æº–å‚™
- [ ] .env ãƒ•ã‚¡ã‚¤ãƒ«ä½œæˆ
- [ ] ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
- [ ] Gitã‚³ãƒŸãƒƒãƒˆï¼ˆä½œæ¥­å‰ï¼‰
- [ ] é–‹ç™ºãƒ–ãƒ©ãƒ³ãƒä½œæˆï¼ˆæŽ¨å¥¨ï¼‰

---

## ðŸ“ æ›´æ–°å±¥æ­´

- 2025-01-05: åˆç‰ˆä½œæˆï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¼•ãç¶™ãŽæ›¸ï¼‰
- å†…å®¹: ä¾¡æ ¼è¨­å®šã€ãƒªã‚»ãƒ©ãƒ¼ãƒ¢ãƒ‡ãƒ«ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼å‹•ç·šã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆã€å®Ÿè£…ãƒ•ã‚§ãƒ¼ã‚º

---

**ã“ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚’èª­ã‚ã°ã€ä»–ã®ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã‚„é–‹ç™ºè€…ãŒå³åº§ã«ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’å¼•ãç¶™ã„ã§å®Ÿè£…ã‚’é–‹å§‹ã§ãã¾ã™ã€‚**
